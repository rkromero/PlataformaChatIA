generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TenantStatus {
  active
  paused
}

enum TenantPlan {
  starter
  pro
  enterprise
}

enum UserRole {
  super_admin
  owner
  admin
  agent
}

enum ChannelType {
  whatsapp
  webchat
}

model Tenant {
  id                    String       @id @default(uuid()) @db.Uuid
  name                  String
  slug                  String?      @unique
  status                TenantStatus @default(active)
  plan                  TenantPlan   @default(starter)
  chatwootAccountId     Int?         @unique @map("chatwoot_account_id")
  onboardingCompleted   Boolean      @default(false) @map("onboarding_completed")
  createdAt             DateTime     @default(now()) @map("created_at")

  users             TenantUser[]
  aiSettings        AiSettings?
  channels          TenantChannel[]
  conversationLinks ConversationLink[]
  usageRecords       UsageRecord[]
  knowledgeEntries   KnowledgeEntry[]
  dailyUsage         DailyUsage[]
  whatsappTemplates  WhatsAppTemplate[]

  @@map("tenants")
}

model TenantUser {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  email         String
  passwordHash  String   @map("password_hash")
  role          UserRole @default(agent)
  emailVerified Boolean  @default(false) @map("email_verified")
  createdAt     DateTime @default(now()) @map("created_at")

  tenant        Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@map("tenant_users")
}

enum TokenType {
  password_reset
  email_verification
  team_invite
}

model Token {
  id        String    @id @default(uuid()) @db.Uuid
  email     String
  type      TokenType
  token     String    @unique
  payload   String?   @db.Text
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")

  @@index([token])
  @@map("tokens")
}

model DailyUsage {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  date      String
  messages  Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@map("daily_usage")
}

model AiSettings {
  tenantId          String   @id @map("tenant_id") @db.Uuid
  enabled           Boolean  @default(true)
  model             String   @default("gpt-4.1-mini")
  systemPrompt      String   @default("Eres un asistente de atención al cliente. Responde de forma breve y útil en español.") @map("system_prompt") @db.Text
  handoffRulesJson  Json     @default("{\"keywords\":[\"humano\",\"asesor\",\"agente\",\"persona\"],\"handoffTag\":\"human_handoff\"}") @map("handoff_rules_json") @db.JsonB
  businessHoursJson Json?    @map("business_hours_json") @db.JsonB
  updatedAt         DateTime @updatedAt @map("updated_at")

  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("ai_settings")
}

model TenantChannel {
  id                  String      @id @default(uuid()) @db.Uuid
  tenantId            String      @map("tenant_id") @db.Uuid
  type                ChannelType @default(whatsapp)
  chatwootInboxId     Int         @map("chatwoot_inbox_id")
  configEncryptedJson String      @map("config_encrypted_json") @db.Text
  createdAt           DateTime    @default(now()) @map("created_at")

  tenant              Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_channels")
}

enum LeadStage {
  new
  contacted
  qualified
  proposal
  won
  lost
}

model ConversationLink {
  id                     String    @id @default(uuid()) @db.Uuid
  tenantId               String    @map("tenant_id") @db.Uuid
  chatwootConversationId Int       @map("chatwoot_conversation_id")
  chatwootContactId      Int?      @map("chatwoot_contact_id")
  phone                  String?
  contactName            String?   @map("contact_name")
  lastMessage            String?   @map("last_message") @db.Text
  stage                  LeadStage @default(new)
  notes                  String?   @db.Text
  crmLeadId              String?   @map("crm_lead_id")
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @updatedAt @map("updated_at")

  tenant                 Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, chatwootConversationId])
  @@index([tenantId, stage])
  @@map("conversation_links")
}

model UsageRecord {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  period    String
  messages  Int      @default(0)
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, period])
  @@map("usage_records")
}

model KnowledgeEntry {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  category  String   @default("general")
  title     String
  content   String   @db.Text
  enabled   Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, enabled])
  @@map("knowledge_entries")
}

model WhatsAppTemplate {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  metaId     String?  @map("meta_id")
  name       String
  language   String   @default("es")
  category   String
  status     String   @default("PENDING")
  components Json     @db.JsonB
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, name, language])
  @@map("whatsapp_templates")
}
